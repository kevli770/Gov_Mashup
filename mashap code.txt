<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8" />
  <title>Zeekr — PDI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Qlik Resources -->
  <link rel="stylesheet" href="../../resources/autogenerated/qlik-styles.css" />
  <script src="../../resources/assets/external/requirejs/require.js"></script>
  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #fee2e2;
      --bg2: #fecaca;
      --bg3: #fca5a5;
      --card: rgba(255, 255, 255, 0.95);
      --text: #1a1a1a;
      --text-secondary: #5c5c5c;
      --muted: #8c8c8c;
      --grid: rgba(0, 0, 0, 0.05);
      --orange: #ef4444;
      --orange-soft: #f56565;
      --orange-light: #fee2e2;
      --green: #22c55e;
      --red: #ef4444;
      --shadow: 0 8px 32px rgba(0, 0, 0, 0.06);
      --shadow-hover: 0 12px 48px rgba(0, 0, 0, 0.1);
      --radius: 20px;
      --line: #f0e7de;
      --glass-bg: rgba(255, 255, 255, 0.7);
      --glass-border: rgba(0, 0, 0, 0.08);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    html, body {
      height: 100%;
      font-family: 'Inter', 'Heebo', system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, var(--bg), var(--bg2) 50%, var(--bg3));
      color: var(--text);
      direction: rtl;
      font-size: 16px;
      line-height: 1.5;
      overflow-x: hidden;
    }

    .wrap {
      display: grid;
      grid-template-columns: 300px 1fr;
      min-height: 100vh;
      gap: 24px;
      padding: 24px;
      max-width: 1920px;
      margin: 0 auto;
    }

    @media (max-width: 1100px) { .wrap { grid-template-columns: 1fr; } }

    /* Sidebar */
    .sidebar {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 28px;
      display: flex;
      flex-direction: column;
      gap: 24px;
      border: 1px solid var(--glass-border);
      position: sticky;
      align-self: start;
      top: 16px;
      max-height: calc(100vh - 32px);
      overflow: auto;
    }

    .profile {
      display: grid;
      grid-template-columns: 64px 1fr;
      align-items: center;
      gap: 16px;
      padding: 20px;
      border-radius: 16px;
      background: linear-gradient(135deg, rgba(239,68,68, 0.1), rgba(239,68,68, 0.05));
      border: 1px solid var(--glass-border);
    }

    .avatar {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--orange), var(--orange-soft));
      display: grid;
      place-items: center;
      box-shadow: 0 6px 20px rgba(239,68,68, 0.2);
      position: relative;
      overflow: hidden;
    }
    .avatar::before { content: "Z"; font-size: 32px; font-weight: 900; color: #fff; letter-spacing: -1px; }
    .avatar::after { content: ""; position: absolute; top: -50%; right: -50%; width: 200%; height: 200%; background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.3), transparent); transform: rotate(45deg); }
    .avatar.logo { background: #fff; background-position: center; background-repeat: no-repeat; background-size: 80%; box-shadow: 0 4px 16px rgba(0,0,0,0.05); }
    .avatar.logo::before, .avatar.logo::after { content: none !important; }

    .name { font-weight: 800; font-size: 22px; color: var(--text); }
    .mail { font-size: 14px; color: var(--text-secondary); font-weight: 500; }

    /* Navigation */
    .nav { display: flex; flex-direction: column; gap: 10px; }
    .nav a {
      text-decoration: none; color: var(--text-secondary); display: flex; align-items: center; gap: 14px;
      font-weight: 600; font-size: 16px; padding: 16px 20px; border-radius: 14px; transition: all 0.3s ease; border: 1px solid transparent;
    }
    .nav a:hover { background: linear-gradient(90deg, rgba(239,68,68,0.15), rgba(239,68,68,0.05)); color: var(--text); transform: translateX(-6px); box-shadow: var(--shadow); }
    .nav a.active { background: linear-gradient(90deg, var(--orange), var(--orange-soft)); color: #fff; font-weight: 700; border-color: transparent; }
    .nav .ico { width: 24px; height: 24px; border-radius: 8px; background: var(--orange-soft); transition: all 0.3s ease; }
    .nav a:hover .ico, .nav a.active .ico { background: var(--orange); transform: scale(1.15); }

    .main { display: grid; grid-template-rows: auto auto 1fr; gap: 20px; }

    /* Filters bar */
    .filters-wrap {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 12px;
      border: 1px solid var(--glass-border);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .main .filters-wrap.stuck + * { margin-top: var(--filters-gap, 0px); }

    .filters-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 4px; }
    .filters-title { font-size: 14px; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.8px; margin: 0; }
    .filters-actions { display: flex; gap: 8px; align-items: center; direction: ltr; }

    /* Selection summary */
    .sel-summary {
      display: none;
      align-items: center;
      gap: 10px;
      margin: 8px 0 10px;
      padding: 10px 12px;
      border-radius: 14px;
      background: linear-gradient(90deg, var(--orange-light), #fff);
      border: 1px solid var(--orange-soft);
      box-shadow: var(--shadow);
    }
    .sel-badge { display: grid; place-items: center; min-width: 32px; height: 32px; padding: 0 10px; font-weight: 900; font-size: 14px; color: #fff; background: linear-gradient(135deg, var(--orange), var(--orange-soft)); border-radius: 999px; box-shadow: 0 6px 16px rgba(239,68,68,.25); }
    .sel-chips { flex: 1; display: flex; gap: 8px; align-items: center; overflow-x: auto; overflow-y: hidden; padding-bottom: 4px; scrollbar-width: thin; }
    .sel-chip-big { display: inline-flex; align-items: center; gap: 10px; background: #fff; border: 1px solid var(--glass-border); color: var(--text); border-radius: 999px; padding: 8px 12px; font-size: 13px; font-weight: 800; white-space: nowrap; direction: ltr; text-align: left; box-shadow: var(--shadow); transition: transform .2s ease; }
    .sel-chip-big:hover { transform: translateY(-2px); }
    .sel-chip-big .k { opacity: .8; }
    .sel-chip-big .v { opacity: .95; }
    .chip-clear { all: unset; cursor: pointer; display: inline-grid; place-items: center; width: 22px; height: 22px; border-radius: 50%; border: 1px solid var(--glass-border); background: var(--orange-light); font-weight: 900; line-height: 1; color: var(--text); }
    .chip-clear:hover { background: #fee2e2; }

    .filters-bar { min-height: 50px; border-radius: 14px; background: var(--card); border: 1px solid var(--line); display: flex; align-items: center; gap: 8px; padding: 8px 12px; flex-wrap: wrap; overflow: hidden; }

    .fblock { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .qvobject { height: 36px; min-width: 120px; max-width: 100%; }
    .qvobject.small { min-width: 80px; }
    .qvobject.calendar { min-width: 180px; }
    .qvobject.master { min-width: 280px; }
    .fsep { width: 1px; height: 28px; background: linear-gradient(to bottom, transparent, rgba(0,0,0,0.1), transparent); opacity: 0.5; }

    .quick-actions { display: flex; gap: 6px; flex-wrap: wrap; align-items: center; }
    .qa-btn { all: unset; cursor: pointer; user-select: none; display: inline-flex; align-items: center; gap: 8px; padding: 8px 12px; border-radius: 10px; font-weight: 700; font-size: 13px; letter-spacing: 0.3px; color: var(--text); background: linear-gradient(180deg, #fff, #fff1f2); border: 1px solid var(--glass-border); box-shadow: var(--shadow); transition: all 0.2s ease; }
    .qa-btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-hover); background: linear-gradient(180deg, #fff, #ffe4e6); }
    .qa-btn:active { transform: translateY(0); box-shadow: var(--shadow); }
    .qa-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--orange); transition: all 0.2s ease; }
    .qa-btn:hover .qa-dot { transform: scale(1.2); }

    .hidden-source { position: absolute; top: -10000px; right: -10000px; opacity: 0.01; pointer-events: none; }
    .hidden-source .qvobject { width: 300px; height: 50px; }

    .clear-all-btn { all: unset; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; background: transparent; color: var(--orange); font-size: 13px; font-weight: 600; padding: 6px 12px; border-radius: 12px; border: 1px solid var(--glass-border); transition: all 0.2s ease; }
    .clear-all-btn:hover { background: rgba(239,68,68,0.1); border-color: var(--orange); transform: scale(1.05); }
    .clear-all-btn svg { width: 14px; height: 14px; }

    /* Cards/slots */
    .grid-1 { display: grid; gap: 20px; grid-template-columns: 1fr; }
    .grid-2 { display: grid; gap: 20px; grid-template-columns: 1fr 1fr; }
    @media (max-width: 1200px) { .grid-2 { grid-template-columns: 1fr; } }

    .card {
      background: var(--glass-bg); backdrop-filter: blur(20px); border-radius: var(--radius); box-shadow: var(--shadow);
      padding: 24px; position: relative; overflow: hidden; border: 1px solid var(--glass-border); transition: all 0.3s ease;
    }
    .card:hover { transform: translateY(-4px); box-shadow: var(--shadow-hover); }
    .card-header { display: flex; align-items: center; justify-content: space-between; padding: 0 0 16px; }
    .card-title { font-weight: 800; font-size: 20px; color: var(--text); letter-spacing: -0.4px; }
    .card-actions { display: flex; gap: 12px; align-items: center; }

    .qvslot { height: 300px; border-radius: 14px; overflow: hidden; direction: ltr; }
    .qvslot.wide { height: 320px; }
    .style-bars { background: linear-gradient(135deg, var(--bg), var(--bg2)); border: 1px solid var(--line); }

    .action-btn { all: unset; cursor: pointer; padding: 10px 16px; border-radius: 12px; font-weight: 700; font-size: 13px; border: 1px solid var(--glass-border); background: linear-gradient(180deg, #fff, #fff1f2); box-shadow: var(--shadow); transition: all 0.2s ease; }
    .action-btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-hover); }

    /* Error Popup */
    .popup { background: var(--red); color: #fff; position: fixed; max-width: 280px; padding: 12px; margin: 16px; bottom: 0; right: 0; display: none; border-radius: 12px; z-index: 1000; box-shadow: var(--shadow); }
    .close { cursor: pointer; background: transparent; border: 0; font-size: 20px; font-weight: 700; line-height: 1; color: #fff; opacity: 0.7; position: absolute; right: 12px; top: 12px; }
    .close:hover { opacity: 1; }
    #popupText { margin-right: 24px; font-size: 14px; }

    /* Modal */
    .modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.5); z-index: 9999; padding: 24px; }
    .modal-content { background: var(--card); width: min(1400px, 95vw); max-height: 90vh; overflow: auto; border-radius: var(--radius); box-shadow: 0 12px 48px rgba(0,0,0,0.2); padding: 24px; position: relative; border: 1px solid var(--glass-border); }
    .modal h3 { margin: 0 0 12px; font-weight: 900; font-size: 24px; color: var(--text); }
    .modal .close-modal { position: absolute; top: 12px; left: 12px; border: none; background: transparent; font-size: 24px; cursor: pointer; opacity: 0.7; color: var(--text); }
    .modal .close-modal:hover { opacity: 1; }
    .modal-slot { width: 100%; height: 75vh; max-height: 80vh; direction: ltr; overflow: hidden; }

    /* Modal actions */
    .modal-actions { display: none; gap: 12px; align-items: center; justify-content: flex-start; margin: 8px 0 12px; }
    .download-btn { all: unset; cursor: pointer; padding: 10px 16px; border-radius: 12px; font-weight: 700; font-size: 13px; border: 1px solid var(--glass-border); background: linear-gradient(180deg, #fff, #fff1f2); box-shadow: var(--shadow); transition: all 0.2s ease; }
    .download-btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-hover); }

    /* Tables */
    .tables-slot { width: 100%; height: 60vh; direction: ltr; border-radius: 14px; overflow: hidden; border: 1px solid var(--line); }
    .tables-actions { display: flex; gap: 12px; align-items: center; justify-content: flex-start; margin: 8px 0 12px; }
    .table-title { font-weight: 800; font-size: 20px; color: var(--text); }

    /* Exporting fixes */
    .exporting *, .exporting .card { transition: none !important; animation: none !important; }
    .exporting-fix, .exporting-fix body, .exporting-fix .wrap { height: auto !important; overflow: visible !important; }

    @media print {
      * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      html, body { height: auto !important; overflow: visible !important; }
      .modal { display: none !important; }
      .card { break-inside: avoid; page-break-inside: avoid; }
      .sidebar { position: static !important; }
    }

    /* KPI Grid */
    :root {
      --k5-glass-bg: var(--glass-bg, rgba(255,255,255,.7));
      --k5-glass-border: var(--glass-border, rgba(0,0,0,.08));
      --k5-line: var(--line, #eee5dc);
      --k5-shadow: var(--shadow, 0 8px 32px rgba(0,0,0,.06));
      --k5-shadow-hover: var(--shadow-hover, 0 12px 48px rgba(0,0,0,.1));
      --k5-orange: var(--orange, #ef4444);
      --k5-orange-soft: var(--orange-soft, #f56565);
      --k5-text: var(--text, #1a1a1a);
      --k5-text-sec: var(--text-secondary, #5c5c5c);
      --k5-radius: var(--radius, 20px);
    }
    .k5-kpi-row { display: grid; gap: 16px; grid-template-columns: repeat(6,1fr); }
    @media (max-width: 1400px) { .k5-kpi-row { grid-template-columns: repeat(4,1fr); } }
    @media (max-width: 1200px) { .k5-kpi-row { grid-template-columns: repeat(3,1fr); } }
    @media (max-width: 900px) { .k5-kpi-row { grid-template-columns: repeat(2,1fr); } }
    @media (max-width: 640px) { .k5-kpi-row { grid-template-columns: 1fr; } }

    .k5-kpi {
      background: var(--k5-glass-bg); backdrop-filter: blur(20px); border-radius: var(--k5-radius);
      box-shadow: var(--k5-shadow); padding: 20px; min-height: 120px; display: grid; gap: 10px;
      border: 1px solid var(--k5-glass-border); position: relative; overflow: hidden; transition: .3s ease;
    }
    .k5-kpi::before { content: ''; position: absolute; inset: 0 0 auto 0; height: 4px; background: linear-gradient(90deg, var(--k5-orange), var(--k5-orange-soft)); }
    .k5-kpi:hover { transform: translateY(-4px); box-shadow: var(--k5-shadow-hover); }

    .k5-kpi-top { display: flex; align-items: flex-start; justify-content: space-between; gap: 14px; }
    .k5-lbl { font-size: 14px; line-height: 1.2; font-weight: 700; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; min-height: calc(1.2em * 2); margin-bottom: 6px; }
    .k5-val { font-size: 36px; font-weight: 900; letter-spacing: -.8px; color: var(--k5-text); line-height: 1.1; }
    .k5-val.k5-loading { font-size: 16px; font-weight: 500; color: var(--k5-text-sec); font-style: italic; }
    .k5-kpi-footer { margin-top: auto; padding-top: 12px; border-top: 1px dashed var(--k5-line); }
    .k5-goal-footer { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    .k5-chip { display: inline-flex; align-items: center; gap: 6px; background: linear-gradient(180deg, #fff, #fff1f2); border: 1px solid var(--k5-glass-border); color: var(--k5-text); border-radius: 10px; padding: 6px 10px; font-size: 12px; font-weight: 700; box-shadow: var(--k5-shadow); }
    .k5-chip-k { opacity: .8; }
    .k5-chip-v { opacity: .95; }
    .k5-chip-v.pos { color: var(--green); font-weight: 800; }
    .k5-chip-v.neg { color: var(--red); font-weight: 800; }
    .k5-chip-v.pos::before { content: "▲"; margin-left: 4px; font-size: .9em; }
    .k5-chip-v.neg::before { content: "▼"; margin-left: 4px; font-size: .9em; }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="profile">
        <div class="avatar"></div>
        <div>
          <div class="name">דו״ח מנהלים</div>
          <div class="mail">Zeekr Dashboard</div>
        </div>
      </div>
      <nav class="nav">
        <a href="Zeekr_LeadToOrder.html"><span class="ico"></span>דשבורד ליד להזמנה</a>
        <a href="Zeekr_OrderToDelivery.html"><span class="ico"></span>דשבורד הזמנה למסירה</a>
        <a href="Zeekr_SalesFunnel.html"><span class="ico"></span>Sales Funnel</a>
        <a href="Zeekr_Stock.html"><span class="ico"></span>מלאי</a>
        <a href="Zeekr_PDI.html" class="active"><span class="ico"></span>PDI</a>
        <a href="Zeekr_TestDriveCarsUsge.html"><span class="ico"></span>ניצול רכבי הדגמה</a>
      </nav>
    </aside>

    <!-- Main -->
    <main class="main">
      <section class="filters-wrap">
        <div class="filters-header">
          <h3 class="filters-title">פילטרים</h3>
          <div class="filters-actions" dir="ltr">
            <button id="clearAllBtn" class="clear-all-btn" title="נקה הכל">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
              נקה הכל
            </button>
            <button id="backBtn" class="clear-all-btn" title="אחורה">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
              אחורה
            </button>
            <button id="forwardBtn" class="clear-all-btn" title="קדימה">
              קדימה
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 6l6 6-6 6"/></svg>
            </button>
            <button id="exportPDFBtn" class="clear-all-btn" title="ייצוא הדף כ-PDF">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 2h9l5 5v13a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2z"></path>
                <path d="M14 2v6h6"></path>
                <path d="M8 15h8M8 19h5M8 11h3"></path>
              </svg>
              ייצוא PDF
            </button>
          </div>
        </div>

        <!-- Selection summary -->
        <div class="sel-summary" id="selSummaryWrap" aria-live="polite">
          <div class="sel-badge" id="selCount">0</div>
          <div class="sel-chips" id="selSummary" title="הבחירות שבוצעו"></div>
          <button id="clearAllBtn2" class="clear-all-btn" title="נקה את כל הבחירות">נקה הכל</button>
        </div>

        <div class="filters-bar">
          <div class="fblock"><div id="obj_calendar" class="qvobject calendar"></div></div>
          <div class="fsep"></div>
          <div class="fblock quick-actions">
            <button class="qa-btn" data-proxy="obj_ytd"><span class="qa-dot"></span>YTD</button>
            <button class="qa-btn" data-proxy="obj_qtd"><span class="qa-dot"></span>QTD</button>
            <button class="qa-btn" data-proxy="obj_mtd"><span class="qa-dot"></span>MTD</button>
            <button class="qa-btn" data-proxy="obj_yesterday"><span class="qa-dot"></span>Yesterday</button>
            <div class="fsep"></div>
            <button class="qa-btn" data-proxy="obj_retail"><span class="qa-dot"></span>Retail</button>
            <button class="qa-btn" data-proxy="obj_fleet"><span class="qa-dot"></span>Fleet</button>
          </div>
          <div class="fsep"></div>
          <div class="fblock"><div id="filtersObject" class="qvobject master"></div></div>
          <div class="hidden-source">
            <div id="obj_ytd" class="qvobject small"></div>
            <div id="obj_qtd" class="qvobject small"></div>
            <div id="obj_mtd" class="qvobject small"></div>
            <div id="obj_yesterday" class="qvobject small"></div>
            <div id="obj_retail" class="qvobject small"></div>
            <div id="obj_fleet" class="qvobject small"></div>
          </div>
        </div>
      </section>

      <section class="grid-2">
        <div class="card">
          <div class="card-header">
            <div class="card-title">לפי סיווג מאגר</div>
            <div class="card-actions">
              <button class="action-btn" data-expand="pdi-by-db-class">הרחב תצוגה</button>
            </div>
          </div>
          <div class="qvslot style-bars" id="pdi-by-db-class"></div>
        </div>
        <div class="card">
          <div class="card-header">
            <div class="card-title">ממוצע ימים ית"ע</div>
            <div class="card-actions">
              <button class="action-btn" data-expand="pdi-avg-days">הרחב תצוגה</button>
            </div>
          </div>
          <div class="qvslot style-bars" id="pdi-avg-days"></div>
        </div>
        <div class="card">
          <div class="card-header">
            <div class="card-title">לפי רישוי</div>
            <div class="card-actions">
              <button class="action-btn" data-expand="pdi-by-licensing">הרחב תצוגה</button>
            </div>
          </div>
          <div class="qvslot style-bars" id="pdi-by-licensing"></div>
        </div>
        <div class="card">
          <div class="card-header">
            <div class="card-title">לפי משפחה</div>
            <div class="card-actions">
              <button class="action-btn" data-expand="pdi-by-family">הרחב תצוגה</button>
            </div>
          </div>
          <div class="qvslot style-bars" id="pdi-by-family"></div>
        </div>
      </section>
    </main>
  </div>

  <!-- Modals -->
  <div class="modal" id="modalViz" aria-hidden="true">
    <div class="modal-content" tabindex="-1">
      <button class="close-modal" id="closeViz" title="סגור">✕</button>
      <h3 id="modalVizTitle">תצוגה מורחבת</h3>
      <div class="modal-actions" id="modalVizActions">
        <button class="download-btn" id="dl_modal_table">הורד טבלה</button>
      </div>
      <div class="modal-slot" id="modalVizSlot"></div>
    </div>
  </div>

  <div class="modal" id="modalMonthlyTable" aria-hidden="true">
    <div class="modal-content" tabindex="-1">
      <button class="close-modal" id="closeMonthlyTable" title="סגור">✕</button>
      <h3>טבלת סקירה חודשית</h3>
      <div class="tables-actions">
        <span class="table-title">טבלת סקירה חודשית</span>
        <button class="download-btn" id="dl_monthly_table">הורד טבלה</button>
      </div>
      <div class="tables-slot" id="table_monthly_review"></div>
    </div>
  </div>

  <div class="modal" id="modalConversionTable" aria-hidden="true">
    <div class="modal-content" tabindex="-1">
      <button class="close-modal" id="closeConversionTable" title="סגור">✕</button>
      <h3>טבלת יחסי המרה</h3>
      <div class="tables-actions">
        <span class="table-title">טבלת יחסי המרה</span>
        <button class="download-btn" id="dl_conversion_table">הורד טבלה</button>
      </div>
      <div class="tables-slot" id="table_conversion"></div>
    </div>
  </div>

  <div class="modal" id="modalH1Table" aria-hidden="true">
    <div class="modal-content" tabindex="-1">
      <button class="close-modal" id="closeH1Table" title="סגור">✕</button>
      <h3>טבלת 2025 H1 – חודשי</h3>
      <div class="tables-actions">
        <span class="table-title">טבלת 2025 H1 – חודשי</span>
        <button class="download-btn" id="dl_h1_table">הורד טבלה</button>
      </div>
      <div class="tables-slot" id="table_h1"></div>
    </div>
  </div>

  <div class="modal" id="modalManufacturerTable" aria-hidden="true">
    <div class="modal-content" tabindex="-1">
      <button class="close-modal" id="closeManufacturerTable" title="סגור">✕</button>
      <h3>טבלת Funnel יצרן</h3>
      <div class="tables-actions">
        <span class="table-title">טבלת Funnel יצרן</span>
        <button class="download-btn" id="dl_manufacturer_table">הורד טבלה</button>
      </div>
      <div class="tables-slot" id="table_manufacturer"></div>
    </div>
  </div>

  <!-- Error Popup -->
  <div id="popup"><button type="button" class="close" id="closePopup">×</button><p id="popupText"></p></div>

  <script>
    /* ========= Qlik Integration ========= */
    var prefix = window.location.pathname.substr(0, window.location.pathname.toLowerCase().lastIndexOf("/extensions") + 1);
    var config = { host: window.location.hostname, prefix: prefix, port: window.location.port, isSecure: window.location.protocol === "https:" };

    (function setBrandLogo(){
      try{
        var base = (config.isSecure ? 'https://' : 'http://') + config.host + (config.port ? ':' + config.port : '') + config.prefix;
        var logoUrl = base + 'content/TGH_Tools/zeekr-logo.png';
        var el = document.querySelector('.avatar');
        if(el){ el.classList.add('logo'); el.style.backgroundImage = 'url("' + logoUrl + '")'; }
      }catch(e){ console.error('Failed to set logo from content library:', e); }
    })();

    require.config({ baseUrl: (config.isSecure ? "https://" : "http://") + config.host + (config.port ? ":" + config.port : "") + config.prefix + "resources" });

    require.config({
      paths: {
        html2canvas: "https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min",
        jspdf: "https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min"
      }
    });

    require(["js/qlik"], function (qlik) {
      qlik.on("error", function (error) {
        if (error && error.message) {
          document.getElementById('popupText').innerHTML = error.message;
          document.getElementById('popup').style.display = 'block';
        }
      });
      document.getElementById("closePopup").addEventListener('click', function () { document.getElementById('popup').style.display = 'none'; });

      var APP_ID = "68b7e4dc-9a11-4fbd-821b-39d329572b7c";
      var FILTERS_OBJ_ID = "1ec69fe1-dd80-4437-ae7c-40fd4e798736";
      var TABLE_ID = "0c3157e9-b42b-4cb8-beb5-deb21ef06da3";
      var CONVERSION_TABLE_ID = "79efe9c5-98c0-4e09-b597-d045a428e629";
      var H1_TABLE_ID = "e37dd637-b32a-4709-946a-b71eb1f0bbfb";
      var MANUFACTURER_TABLE_ID = "79d98c5b-8d01-479c-8fef-5c9f30af22f4";

      var app = qlik.openApp(APP_ID, config);
      window.qlikApp = app;

      var VIZ_IDS = {
        'pdi-by-db-class':   '0b3d8d8c-3c64-4b2e-a43d-dc162b16d058',
        'pdi-avg-days':      'de4c8a6a-1297-4be2-a85d-e004446383db',
        'pdi-by-licensing':  '4291543e-8bc2-4e0d-976a-e42c20558e5d',
        'pdi-by-family':     '421371ee-280a-4171-a3ea-de1326d64eb8'
      };

      Object.keys(VIZ_IDS).forEach(function(domId) {
        app.getObject(domId, VIZ_IDS[domId]).catch(function(err) {
          document.getElementById('popupText').innerHTML = 'שגיאה בטעינת ויזואליזציה: ' + domId;
          document.getElementById('popup').style.display = 'block';
        });
      });

      app.getObject("obj_calendar",   "dbc2597d-950d-430b-b364-8cedccc225d4");
      app.getObject("obj_ytd",        "2eadb7aa-c082-4731-a040-22cbcdec93f8");
      app.getObject("obj_qtd",        "eacf0df2-9ae7-49a5-b99b-e3b07d7ed97c");
      app.getObject("obj_mtd",        "6ec1a1dd-9692-4ccb-a4d2-ee9642f4864a");
      app.getObject("obj_yesterday",  "31a01b43-64a4-4cad-ab77-0d67c6dc0290");
      app.getObject("obj_retail",     "e104d0ee-17fb-469b-b69b-ff468b73e839");
      app.getObject("obj_fleet",      "f20308e2-9512-41da-9124-e9d0e235c50a");
      app.getObject("filtersObject",  FILTERS_OBJ_ID);

      function $(id) { return document.getElementById(id); }
      function safe(fn) { try { fn && fn(); } catch (e) {} }
      $("clearAllBtn") && $("clearAllBtn").addEventListener("click", function(){ safe(function(){ app.clearAll(); }); });
      $("clearAllBtn2") && $("clearAllBtn2").addEventListener("click", function(){ safe(function(){ app.clearAll(); }); });
      $("backBtn") && $("backBtn").addEventListener("click", function(){ safe(function(){ app.back(); }); });
      $("forwardBtn") && $("forwardBtn").addEventListener("click", function(){ safe(function(){ app.forward(); }); });

      function truncate(txt, max) {
        if (txt == null) return '';
        txt = String(txt);
        return txt.length > max ? txt.slice(0, max - 1) + '…' : txt;
      }

      function renderSelections(items) {
        var sumWrap = $("selSummaryWrap");
        var sumList = $("selSummary");
        var sumCount = $("selCount");

        if (!sumWrap || !sumList || !sumCount) return;
        sumList.innerHTML = '';
        if (!items || !items.length) {
          sumWrap.style.display = 'none';
          sumCount.textContent = '0';
          return;
        }
        sumWrap.style.display = 'flex';
        sumCount.textContent = items.length;

        items.forEach(function(s) {
          var chip = document.createElement('span');
          chip.className = 'sel-chip-big';
          chip.title = s.qField + ': ' + (s.qSelected || (s.qSelectedCount || ''));

          var k = document.createElement('span'); k.className = 'k'; k.textContent = s.qField + ':';
          var v = document.createElement('span'); v.className = 'v';
          var valText = s.qSelected && s.qSelected.trim() ? s.qSelected : (s.qSelectedCount ? (s.qSelectedCount + ' ערכים') : '');
          v.textContent = truncate(valText, 28);

          var btn = document.createElement('button');
          btn.className = 'chip-clear';
          btn.setAttribute('type', 'button');
          btn.setAttribute('title', 'נקה בחירה בשדה זה');
          btn.setAttribute('aria-label', 'נקה בחירה בשדה ' + s.qField);
          btn.dataset.field = s.qField;
          btn.textContent = '×';

          chip.appendChild(k); chip.appendChild(v); chip.appendChild(btn);
          sumList.appendChild(chip);
        });
      }

      document.getElementById('selSummary')?.addEventListener('click', function(e) {
        var target = e.target.closest('.chip-clear');
        if (!target) return;
        var field = target.dataset.field;
        if (field && window.qlikApp) {
          try { window.qlikApp.field(field).clear(); } catch(_) {}
        }
      });

      app.getList('CurrentSelections', function(reply) {
        var sels = (reply.qSelectionObject && reply.qSelectionObject.qSelections) || [];
        renderSelections(sels.map(function(s) { return { qField: s.qField, qSelected: s.qSelected, qSelectedCount: s.qSelectedCount }; }));
      });

      function clickInsideQlikObject(hostId) {
        var host = document.getElementById(hostId);
        if (!host) return false;
        var tryClick = function() {
          var btn = host.querySelector('button, [role="button"], .qv-object-button, .qv-action-button, .qv-inner-object button, .lui-button');
          if (btn) { btn.click(); return true; }
          var clickable = host.querySelector('[data-qcmd], .qv-collapsed-listbox, .qv-listbox li, .qv-hello-world');
          if (clickable) { clickable.dispatchEvent(new MouseEvent('click', { bubbles: true })); return true; }
          return false;
        };
        if (tryClick()) return true;
        var mo = new MutationObserver(function(){ if (tryClick()) { mo.disconnect(); } });
        mo.observe(host, { childList: true, subtree: true });
        setTimeout(function(){ tryClick(); mo.disconnect(); }, 5000);
        return true;
      }
      document.querySelectorAll('.qa-btn[data-proxy]').forEach(function(el) {
        el.addEventListener('click', function() { clickInsideQlikObject(el.getAttribute('data-proxy')); });
      });

      var modalViz = $('modalViz');
      var modalVizSlot = $('modalVizSlot');
      var modalVizTitle = $('modalVizTitle');
      var modalVizActions = $('modalVizActions');
      var dlModalBtn = $('dl_modal_table');
      var currentExpanded = null;

      function forceResize() {
        try { qlik.resize(); } catch(_) {}
        setTimeout(function(){ try { qlik.resize(); } catch(_) {} }, 300);
        try { window.dispatchEvent(new Event('resize')); } catch(_) {}
      }

      // ניהול "ניתוק זמני" ל־pdi-avg-days כדי לא להציג Container פעמיים
      var temporarilyHidden = {};
      function detachOriginal(domId){
        var el = $(domId);
        if(!el) return;
        temporarilyHidden[domId] = true;
        el.dataset.__prevDisplay = el.style.display || '';
        el.style.display = 'none';
        el.innerHTML = ''; // מנתק DOM של ה־qvobject
      }
      function reattachOriginal(domId, objId){
        var el = $(domId);
        if(!el) return;
        if(temporarilyHidden[domId]){
          el.style.display = el.dataset.__prevDisplay || '';
          delete el.dataset.__prevDisplay;
          delete temporarilyHidden[domId];
        }
        app.getObject(domId, objId).then(forceResize).catch(function(){});
      }

      function openVizModal(fromDomId) {
        currentExpanded = fromDomId;
        if (!modalViz || !modalVizSlot || !modalVizTitle) { return; }
        modalViz.style.display = 'flex';
        modalViz.setAttribute('aria-hidden', 'false');
        modalVizSlot.innerHTML = '';
        var title = document.querySelector('[data-expand="' + fromDomId + '"]')?.closest('.card')?.querySelector('.card-title')?.textContent || 'תצוגה מורחבת';
        modalVizTitle.textContent = title;
        var showDl = (fromDomId === 'pdi-by-licensing' || fromDomId === 'pdi-by-family');
        if (modalVizActions) modalVizActions.style.display = showDl ? 'flex' : 'none';
        if (dlModalBtn) {
          dlModalBtn.onclick = null;
          if (showDl) {
            var vizIdForDl = VIZ_IDS[fromDomId];
            dlModalBtn.onclick = function(){ exportByVizId(vizIdForDl, title.replace(/\s+/g,'-')); };
          }
        }

        var objId = VIZ_IDS[fromDomId];
        if (objId) {
          if (fromDomId === 'pdi-avg-days') {
            // ✅ פתרון ספציפי ל־Container: לא להציג פעמיים, מנתקים ואז show במודאל
            detachOriginal(fromDomId);
            app.visualization.get(objId).then(function(vis){
              requestAnimationFrame(function(){
                try { vis.show('modalVizSlot'); } catch(_) {}
                try { if (typeof vis.activate === 'function') vis.activate(); } catch(_) {}
                forceResize();
              });
            }).catch(function(){
              // גיבוי
              app.getObject('modalVizSlot', objId).then(forceResize).catch(function(){
                document.getElementById('popupText').innerHTML = 'שגיאה בטעינת ויזואליזציה מורחבת: ' + fromDomId;
                document.getElementById('popup').style.display = 'block';
              });
            });
          } else {
            app.getObject('modalVizSlot', objId).then(forceResize).catch(function(){
              document.getElementById('popupText').innerHTML = 'שגיאה בטעינת ויזואליזציה מורחבת: ' + fromDomId;
              document.getElementById('popup').style.display = 'block';
            });
          }
        }
        setTimeout(function() { document.getElementById('closeViz')?.focus(); }, 0);
      }

      function closeVizModal() {
        modalViz.style.display = 'none';
        modalViz.setAttribute('aria-hidden', 'true');

        if (currentExpanded && VIZ_IDS[currentExpanded]) {
          if (currentExpanded === 'pdi-avg-days') {
            // מחזירים את האובייקט המקורי לכרטיס שלו
            reattachOriginal(currentExpanded, VIZ_IDS[currentExpanded]);
          } else {
            app.getObject(currentExpanded, VIZ_IDS[currentExpanded]).catch(function(){});
          }
          forceResize();
        }

        currentExpanded = null;
        modalVizSlot.innerHTML = '';
      }

      $('closeViz')?.addEventListener('click', closeVizModal);
      modalViz?.addEventListener('click', function(e){ if (e.target === modalViz) { closeVizModal(); } });
      document.querySelectorAll('.action-btn[data-expand]').forEach(function(btn){
        btn.addEventListener('click', function(){ openVizModal(btn.getAttribute('data-expand')); });
      });

      var modalMonthlyTable = $('modalMonthlyTable');
      var modalConversionTable = $('modalConversionTable');
      var modalH1Table = $('modalH1Table');
      var modalManufacturerTable = $('modalManufacturerTable');

      var objectsMap = {};
      function ensureLoaded(domId, objId) {
        return new Promise(function(resolve){
          var qobj = objectsMap[domId];
          if (qobj) { resolve(qobj); return; }
          app.getObject(domId, objId).then(function(newObj){
            objectsMap[domId] = newObj; resolve(newObj);
          }).catch(function(err){
            document.getElementById('popupText').innerHTML = 'שגיאה: לא ניתן לטעון טבלה עבור ' + domId + ': ' + (err.message || err);
            document.getElementById('popup').style.display = 'block';
            resolve(null);
          });
        });
      }

      function openMonthlyTable(){ if (!modalMonthlyTable) return; modalMonthlyTable.style.display='flex'; modalMonthlyTable.setAttribute('aria-hidden','false'); setTimeout(function(){ ensureLoaded('table_monthly_review', TABLE_ID); $('closeMonthlyTable')?.focus(); }, 600); }
      function closeMonthlyTable(){ modalMonthlyTable.style.display='none'; modalMonthlyTable.setAttribute('aria-hidden','true'); }
      function openConversionTable(){ if (!modalConversionTable) return; modalConversionTable.style.display='flex'; modalConversionTable.setAttribute('aria-hidden','false'); setTimeout(function(){ ensureLoaded('table_conversion', CONVERSION_TABLE_ID); $('closeConversionTable')?.focus(); }, 600); }
      function closeConversionTable(){ modalConversionTable.style.display='none'; modalConversionTable.setAttribute('aria-hidden','true'); }
      function openH1Table(){ if (!modalH1Table) return; modalH1Table.style.display='flex'; modalH1Table.setAttribute('aria-hidden','false'); setTimeout(function(){ ensureLoaded('table_h1', H1_TABLE_ID); $('closeH1Table')?.focus(); }, 600); }
      function closeH1Table(){ modalH1Table.style.display='none'; modalH1Table.setAttribute('aria-hidden','true'); }
      function openManufacturerTable(){ if (!modalManufacturerTable) return; modalManufacturerTable.style.display='flex'; modalManufacturerTable.setAttribute('aria-hidden','false'); setTimeout(function(){ ensureLoaded('table_manufacturer', MANUFACTURER_TABLE_ID); $('closeManufacturerTable')?.focus(); }, 600); }
      function closeManufacturerTable(){ modalManufacturerTable.style.display='none'; modalManufacturerTable.setAttribute('aria-hidden','true'); }

      function toAbsUrl(res){
        var url = (res && (res.qUrl || res.url || res.result || res)) || '';
        if(!url) return '';
        if(/^https?:\/\//i.test(url)) return url;
        var base = (config.isSecure ? 'https://' : 'http://') + config.host + (config.port ? ':' + config.port : '') + config.prefix;
        if(url.charAt(0) === '/') url = url.substring(1);
        return base + url;
      }
      function triggerDownload(url, filename){
        try{
          var baseHost = (config.host + (config.port ? (':' + config.port) : ''));
          var sameOrigin = url.indexOf(baseHost) !== -1;
          if(sameOrigin){
            var a = document.createElement('a'); a.href = url;
            if(filename) a.setAttribute('download', filename);
            a.rel = 'noopener';
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
          }else{ window.open(url, '_blank'); }
        }catch(e){ window.open(url, '_blank'); }
      }
      function exportByVizId(vizId, filenameBase){
        return app.visualization.get(vizId).then(function(vis){
          return vis.exportData({ format:'OOXML' }).then(function(res){
            triggerDownload(toAbsUrl(res), (filenameBase||'export') + '.xlsx');
          }, function(){
            return vis.exportData({ format:'CSV_C' }).then(function(res){
              triggerDownload(toAbsUrl(res), (filenameBase||'export') + '.csv');
            });
          });
        }).catch(function(err){
          document.getElementById('popupText').innerHTML = 'שגיאה בייצוא טבלה: ' + (err.message || err);
          document.getElementById('popup').style.display = 'block';
        });
      }

      function exportWholePagePDF() {
        require(['html2canvas','jspdf'], function (html2canvas, jspdf) {
          const { jsPDF } = jspdf || window.jspdf || {};
          if (!html2canvas || !jsPDF) {
            alert('בעיה בטעינת רכיבי ה-PDF. נסה/י שוב.'); return;
          }

          var openModals = Array.from(document.querySelectorAll('.modal')).filter(m => m.style.display === 'flex');
          openModals.forEach(m => m.dataset.__reopen = '1');
          openModals.forEach(m => m.style.display = 'none');

          document.documentElement.classList.add('exporting-fix');
          document.body.classList.add('exporting');

          var prevScroll = { x: window.scrollX, y: window.scrollY };
          window.scrollTo(0, 0);

          var target = document.documentElement;
          var width  = Math.max(target.scrollWidth,  document.body.scrollWidth,  document.documentElement.scrollWidth);
          var height = Math.max(target.scrollHeight, document.body.scrollHeight, document.documentElement.scrollHeight);

          html2canvas(target, {
            scale: 2,
            useCORS: true,
            backgroundColor: null,
            windowWidth:  width,
            windowHeight: height,
            width:  width,
            height: height,
            scrollX: 0,
            scrollY: 0
          }).then(function(canvas){
            var imgData = canvas.toDataURL('image/png');
            var pdf = new jsPDF('l', 'pt', 'a4');
            var pageW = pdf.internal.pageSize.getWidth();
            var pageH = pdf.internal.pageSize.getHeight();
            var imgW = pageW;
            var imgH = canvas.height * (imgW / canvas.width);
            var heightLeft = imgH;
            var position = 0;

            pdf.addImage(imgData, 'PNG', 0, position, imgW, imgH);
            heightLeft -= pageH;
            while (heightLeft > 0) {
              position = -(imgH - heightLeft);
              pdf.addPage();
              pdf.addImage(imgData, 'PNG', 0, position, imgW, imgH);
              heightLeft -= pageH;
            }
            pdf.save('PDI.pdf');

            document.body.classList.remove('exporting');
            document.documentElement.classList.remove('exporting-fix');
            window.scrollTo(prevScroll.x, prevScroll.y);
            document.querySelectorAll('.modal').forEach(function(m){
              if (m.dataset.__reopen === '1') { m.style.display = 'flex'; delete m.dataset.__reopen; }
            });
          }).catch(function(err){
            console.error('PDF export error:', err);
            document.body.classList.remove('exporting');
            document.documentElement.classList.remove('exporting-fix');
            window.scrollTo(prevScroll.x, prevScroll.y);
            alert('אירעה שגיאה ביצוא ה-PDF');
          });
        });
      }
      document.getElementById('exportPDFBtn')?.addEventListener('click', exportWholePagePDF);

      (function pinFiltersNoOverlap(){
        var fw = document.querySelector('.filters-wrap');
        if (!fw) return;

        function setGap(){
          var h = fw.getBoundingClientRect().height || fw.offsetHeight || 0;
          document.documentElement.style.setProperty('--filters-gap', (h + 8) + 'px');
        }

        setGap();
        var ro = new ResizeObserver(setGap);
        ro.observe(fw);
        window.addEventListener('resize', setGap, {passive: true});

        function onScroll(){
          if (fw.getBoundingClientRect().top <= 0) fw.classList.add('stuck');
          else fw.classList.remove('stuck');
        }
        window.addEventListener('scroll', onScroll, {passive: true});
        onScroll();
      })();

      /* ======== ESC to close any open modal ======== */
      document.addEventListener('keydown', function(e){
        if (e.key !== 'Escape' && e.key !== 'Esc') return;
        var openModals = Array.from(document.querySelectorAll('.modal')).filter(function(m){
          return window.getComputedStyle(m).display === 'flex';
        });
        if (!openModals.length) return;
        var topModal = openModals[openModals.length - 1];
        switch (topModal.id) {
          case 'modalViz':               closeVizModal(); break;
          case 'modalMonthlyTable':      closeMonthlyTable(); break;
          case 'modalConversionTable':   closeConversionTable(); break;
          case 'modalH1Table':           closeH1Table(); break;
          case 'modalManufacturerTable': closeManufacturerTable(); break;
        }
        e.preventDefault();
      });
      /* ======== end ESC addition ======== */

    }, function(err) {
      document.getElementById('popupText').innerHTML = 'שגיאה בטעינת ספריית Qlik';
      document.getElementById('popup').style.display = 'block';
    });
  </script>
</body>
</html>